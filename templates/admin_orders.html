{% extends "base_admin.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h4 mb-0">üõçÔ∏è Orders</h1>
  <div class="text-muted">
    Total: {{ orders|length }} orders
  </div>
</div>

{% if orders %}
  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Order #</th>
            <th>Customer</th>
            <th>Contact</th>
            <th>Items</th>
            <th>Total</th>
            <th>Payment</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
            {% set items = order.items_json|fromjson if order.items_json else [] %}
            <tr>
              <td>
                <code class="fs-6">#{{ order.id }}</code>
              </td>
              <td>
                <strong>{{ order.customer_name }}</strong><br>
                <small class="text-muted">{{ order.email }}</small>
              </td>
              <td>
                <small class="text-muted">
                  üì± {{ order.phone }}<br>
                  üìç {{ order.address[:30] if order.address else '' }}{% if order.address and order.address|length > 30 %}...{% endif %}
                </small>
              </td>
              <td>
                <small>
                  {% if items %}
                    {% for item in items[:3] %}
                      {{ item.qty }}√ó {{ item.name }}<br>
                    {% endfor %}
                    {% if items|length > 3 %}
                      <em>...and {{ items|length - 3 }} more</em>
                    {% endif %}
                  {% else %}
                    <em class="text-muted">No items</em>
                  {% endif %}
                </small>
              </td>
              <td>
                <strong>{{ order.subtotal|gyd }}</strong>
              </td>
              <td>
                <span class="badge bg-{{ 'primary' if order.payment_method == 'paypal' else 'secondary' }}">
                  {{ order.payment_method|title if order.payment_method else 'Unknown' }}
                </span>
              </td>
              <td>
                <span class="badge bg-{{ 'success' if order.status == 'paid' else 'warning' }}">
                  {{ order.status|title if order.status else 'Pending' }}
                </span>
              </td>
              <td>
                <small class="text-muted">
                  {% if order.created_at %}
                    {{ order.created_at.strftime('%Y-%m-%d') }}<br>
                    {{ order.created_at.strftime('%H:%M') }}
                  {% else %}
                    N/A
                  {% endif %}
                </small>
              </td>
              <td>
                <div class="admin-table-actions">
                  <!-- View Details Modal Trigger -->
                  <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#orderModal{{ order.id }}" title="View Details">
                    üëÅÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}
  <div class="card">
    <div class="card-body text-center py-5">
      <div class="display-1 text-muted mb-3">üìã</div>
      <h4 class="text-muted">No Orders Yet</h4>
      <p class="text-muted">Orders will appear here when customers make purchases.</p>
      <a href="{{ url_for('admin.admin_products') }}" class="btn btn-primary">
        Add Products
      </a>
    </div>
  </div>
{% endif %}

<!-- Order Detail Modals -->
{% for order in orders %}
  {% set items = order.items_json|fromjson if order.items_json else [] %}
  <div class="modal fade" id="orderModal{{ order.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Order #{{ order.id }} Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-4">
            <!-- Customer Info -->
            <div class="col-md-6">
              <h6>Customer Information</h6>
              <table class="table table-sm">
                <tr><th>Name:</th><td>{{ order.customer_name if order.customer_name else 'N/A' }}</td></tr>
                <tr><th>Email:</th><td>{{ order.email if order.email else 'N/A' }}</td></tr>
                <tr><th>Phone:</th><td>{{ order.phone if order.phone else 'N/A' }}</td></tr>
                <tr><th>Address:</th><td>{{ order.address if order.address else 'N/A' }}</td></tr>
              </table>
            </div>
            
            <!-- Order Info -->
            <div class="col-md-6">
              <h6>Order Information</h6>
              <table class="table table-sm">
                <tr><th>Date:</th><td>{{ order.created_at.strftime('%Y-%m-%d %H:%M') if order.created_at else 'N/A' }}</td></tr>
                <tr><th>Payment:</th><td>{{ order.payment_method|title if order.payment_method else 'Unknown' }}</td></tr>
                <tr><th>Status:</th><td>
                  <span class="badge bg-{{ 'success' if order.status == 'paid' else 'warning' }}">
                    {{ order.status|title if order.status else 'Pending' }}
                  </span>
                </td></tr>
                <tr><th>Total:</th><td><strong>{{ order.subtotal|gyd }}</strong></td></tr>
              </table>
            </div>
            
            <!-- Items -->
            <div class="col-12">
              <h6>Order Items</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr><th>Product</th><th>Price</th><th>Qty</th><th>Total</th></tr>
                  </thead>
                  <tbody>
                    {% if items %}
                      {% for item in items %}
                      <tr>
                        <td>{{ item.name if item.name else 'Unknown Product' }}</td>
                        <td>GYD ${{ "%.2f"|format(item.price) if item.price else '0.00' }}</td>
                        <td>{{ item.qty if item.qty else 0 }}</td>
                        <td>GYD ${{ "%.2f"|format(item.price * item.qty) if item.price and item.qty else '0.00' }}</td>
                      </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="4" class="text-center text-muted">No items data available</td>
                      </tr>
                    {% endif %}
                  </tbody>
                  <tfoot>
                    <tr class="fw-bold">
                      <td colspan="3">Subtotal:</td>
                      <td>{{ order.subtotal|gyd }}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
{% endfor %}
{% endblock %}
