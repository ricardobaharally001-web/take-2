{% extends "base_store.html" %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">Our Products</h1>
    <p class="text-muted mb-0">Discover our amazing collection</p>
  </div>
  <div class="d-flex align-items-center gap-2">
    <span class="badge bg-light text-dark">{{ products|length }} products</span>
  </div>
</div>

<!-- Search and Filter Bar -->
<div class="search-filter-bar mb-4">
  <form class="row g-3" method="get">
    <div class="col-md-5">
      <div class="input-group">
        <span class="input-group-text">
          <i class="bi bi-search"></i>
        </span>
        <input class="form-control" type="search" name="q" value="{{ q }}" placeholder="Search products...">
      </div>
    </div>
    <div class="col-md-4">
      <select class="form-select" name="category">
        <option value="">All categories</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {% if category_id == c.id|string %}selected{% endif %}>
            {{ c.name }} ({{ c.product_count() }})
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <button class="btn btn-primary w-100" type="submit">
        <i class="bi bi-funnel me-1"></i>
        Filter
      </button>
    </div>
  </form>
  
  <!-- Active filters -->
  {% if q or category_id %}
    <div class="mt-3">
      <small class="text-muted me-2">Active filters:</small>
      {% if q %}
        <span class="badge bg-primary me-2">
          Search: "{{ q }}"
          <a href="{{ url_for('store.products_view', category=category_id if category_id else '') }}" class="text-white text-decoration-none ms-1">×</a>
        </span>
      {% endif %}
      {% if category_id %}
        {% for c in categories if c.id|string == category_id %}
          <span class="badge bg-primary me-2">
            Category: {{ c.name }}
            <a href="{{ url_for('store.products_view', q=q if q else '') }}" class="text-white text-decoration-none ms-1">×</a>
          </span>
        {% endfor %}
      {% endif %}
      <a href="{{ url_for('store.products_view') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-x me-1"></i>
        Clear all
      </a>
    </div>
  {% endif %}
</div>

<!-- Products Grid -->
{% if products %}
  <div class="product-grid">
    {% for p in products %}
      <div class="card h-100 product-card">
        {% set img_src = p.image_filename if p.image_filename and p.image_filename.startswith('http') else (url_for('uploaded_file', filename=p.image_filename) if p.image_filename else 'https://via.placeholder.com/400x300/f8f9fa/6c757d?text=Product') %}
        
        <div class="position-relative overflow-hidden">
          <img class="card-img-top" src="{{ img_src }}" alt="{{ p.name }}" loading="lazy">
          {% if p.stock_quantity <= 5 and p.stock_quantity > 0 %}
            <span class="position-absolute top-0 start-0 badge bg-warning text-dark m-2">
              Only {{ p.stock_quantity }} left!
            </span>
          {% elif p.stock_quantity == 0 %}
            <span class="position-absolute top-0 start-0 badge bg-danger m-2">
              Out of Stock
            </span>
          {% endif %}
        </div>
        
        <div class="card-body d-flex flex-column">
          <div class="mb-2">
            {% if p.category %}
              <span class="badge bg-light text-dark small">{{ p.category }}</span>
            {% endif %}
          </div>
          
          <h3 class="card-title h6 mb-2">{{ p.name }}</h3>
          
          {% if p.description %}
            <p class="card-text text-muted small mb-3">{{ p.description[:80] }}{% if p.description|length > 80 %}...{% endif %}</p>
          {% endif %}
          
          <div class="mt-auto">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="price">{{ p.price|gyd }}</span>
              <div class="stock-indicator {{ 'in-stock' if p.stock_quantity > 5 else ('low-stock' if p.stock_quantity > 0 else 'out-of-stock') }}">
                <i class="bi bi-circle-fill"></i>
                <span>{{ 'In Stock' if p.stock_quantity > 5 else ('Low Stock' if p.stock_quantity > 0 else 'Out of Stock') }}</span>
              </div>
            </div>
            
            <div class="d-grid gap-2">
              <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('store.product_detail', product_id=p.id) }}">
                <i class="bi bi-eye me-1"></i>
                View Details
              </a>
              {% if p.stock_quantity > 0 %}
                <button class="btn btn-primary btn-sm add-to-cart-btn" data-product-id="{{ p.id }}">
                  <i class="bi bi-cart-plus me-1"></i>
                  Add to Cart
                </button>
              {% else %}
                <button class="btn btn-secondary btn-sm" disabled>
                  <i class="bi bi-x-circle me-1"></i>
                  Out of Stock
                </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  
  <!-- Results summary -->
  <div class="text-center mt-5">
    <p class="text-muted">
      Showing {{ products|length }} product{{ 's' if products|length != 1 else '' }}
      {% if q or category_id %}
        {% if q and category_id %}
          for "{{ q }}" in {{ categories|selectattr('id', 'equalto', category_id|int)|map(attribute='name')|first }}
        {% elif q %}
          for "{{ q }}"
        {% elif category_id %}
          in {{ categories|selectattr('id', 'equalto', category_id|int)|map(attribute='name')|first }}
        {% endif %}
      {% endif %}
    </p>
  </div>
  
{% else %}
  <!-- Empty State -->
  <div class="text-center py-5">
    <div class="mb-4">
      {% if q or category_id %}
        <i class="bi bi-search display-1 text-muted"></i>
      {% else %}
        <i class="bi bi-shop display-1 text-muted"></i>
      {% endif %}
    </div>
    
    {% if q or category_id %}
      <h4 class="text-muted mb-3">No products found</h4>
      <p class="text-muted mb-4">
        We couldn't find any products matching your search criteria.
        {% if q %}
          <br>Try searching for "{{ q }}" with different keywords.
        {% endif %}
      </p>
      <div class="d-flex gap-2 justify-content-center flex-wrap">
        <a href="{{ url_for('store.products_view') }}" class="btn btn-primary">
          <i class="bi bi-grid-3x3-gap me-2"></i>
          View All Products
        </a>
        {% if categories %}
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-folder me-2"></i>
              Browse Categories
            </button>
            <ul class="dropdown-menu">
              {% for c in categories %}
                <li>
                  <a class="dropdown-item" href="{{ url_for('store.products_view', category=c.id) }}">
                    {{ c.name }} ({{ c.product_count() }})
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </div>
    {% else %}
      <h4 class="text-muted mb-3">No products available</h4>
      <p class="text-muted mb-4">
        We're working hard to bring you amazing products. Check back soon!
      </p>
      {% if settings.contact_email %}
        <a href="mailto:{{ settings.contact_email }}" class="btn btn-outline-primary">
          <i class="bi bi-envelope me-2"></i>
          Get Notified When We Launch
        </a>
      {% endif %}
    {% endif %}
  </div>
{% endif %}

<!-- Browse Categories -->
{% if categories and not category_id %}
  <section class="mt-5 pt-5 border-top">
    <div class="container">
      <h3 class="h4 mb-4 text-center">Shop by Category</h3>
      <div class="row g-3">
        {% for c in categories %}
          <div class="col-6 col-md-4 col-lg-3">
            <a href="{{ url_for('store.products_view', category=c.id) }}" class="text-decoration-none">
              <div class="card h-100 text-center category-card">
                <div class="card-body">
                  <i class="bi bi-folder2-open display-6 text-primary mb-2"></i>
                  <h6 class="card-title mb-1">{{ c.name }}</h6>
                  <small class="text-muted">{{ c.product_count() }} product{{ 's' if c.product_count() != 1 else '' }}</small>
                </div>
              </div>
            </a>
          </div>
        {% endfor %}
      </div>
    </div>
  </section>
{% endif %}
{% endblock %}
