{% extends "base_store.html" %}

{% block content %}
<!-- Page Header -->
<div class="row align-items-center mb-4">
  <div class="col">
    <h1 class="h3 mb-1">Checkout</h1>
    <p class="text-muted mb-0">Complete your order securely</p>
  </div>
  <div class="col-auto">
    <a href="{{ url_for('store.cart_view') }}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-2"></i>
      Back to Cart
    </a>
  </div>
</div>

<!-- Checkout Process -->
<div class="row g-4">
  <!-- Customer Information -->
  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-person me-2"></i>
          Customer Information
        </h5>
      </div>
      <div class="card-body">
        <form id="checkout-form" class="checkout-form">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Full Name *</label>
              <input class="form-control" name="name" required placeholder="Enter your full name">
              <div class="invalid-feedback">Please provide your full name.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Email Address *</label>
              <input class="form-control" name="email" type="email" required placeholder="your@email.com">
              <div class="invalid-feedback">Please provide a valid email address.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Phone Number *</label>
              <input class="form-control" name="phone" required placeholder="+592 600 0000">
              <div class="invalid-feedback">Please provide your phone number.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Country</label>
              <select class="form-select" disabled>
                <option selected>Guyana</option>
              </select>
              <small class="form-text text-muted">Currently serving Guyana only</small>
            </div>
            <div class="col-12">
              <label class="form-label">Delivery Address *</label>
              <textarea class="form-control" name="address" rows="3" required placeholder="Enter your complete delivery address"></textarea>
              <div class="invalid-feedback">Please provide your delivery address.</div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Payment Methods -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-credit-card me-2"></i>
          Payment Method
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card payment-method-card h-100" data-method="paypal">
              <div class="card-body text-center">
                <i class="bi bi-paypal display-6 text-primary mb-3"></i>
                <h6>PayPal</h6>
                <p class="text-muted small mb-3">Pay securely with your PayPal account</p>
                <button class="btn btn-primary w-100" id="pay-paypal" type="button">
                  <i class="bi bi-paypal me-2"></i>
                  Pay with PayPal
                </button>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card payment-method-card h-100" data-method="cash">
              <div class="card-body text-center">
                <i class="bi bi-cash-coin display-6 text-success mb-3"></i>
                <h6>Cash on Delivery</h6>
                <p class="text-muted small mb-3">Pay when your order is delivered</p>
                <button class="btn btn-success w-100" id="pay-cash" type="button">
                  <i class="bi bi-cash-coin me-2"></i>
                  Pay with Cash
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- MMG Payment Instructions -->
        {% if settings.mmg_instructions %}
        <div class="alert alert-info mt-3">
          <h6 class="alert-heading">
            <i class="bi bi-info-circle me-2"></i>
            Alternative Payment: MMG
          </h6>
          <p class="mb-0">{{ settings.mmg_instructions }}</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Order Summary -->
  <div class="col-lg-4">
    <div class="card sticky-top" style="top: 100px;">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-receipt me-2"></i>
          Order Summary
        </h5>
      </div>
      <div class="card-body">
        <!-- Order Items -->
        <div class="mb-3">
          {% for item in items %}
            <div class="d-flex align-items-center mb-2">
              <div class="flex-shrink-0 me-2">
                {% set img_src = item.image_filename if item.image_filename and item.image_filename.startswith('http') else (url_for('uploaded_file', filename=item.image_filename) if item.image_filename else 'https://via.placeholder.com/40x40/f8f9fa/6c757d?text=Item') %}
                <img src="{{ img_src }}" alt="{{ item.name }}" class="rounded" style="width: 40px; height: 40px; object-fit: cover;">
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-0 small">{{ item.name }}</h6>
                <small class="text-muted">Qty: {{ item.qty }} Ã— {{ item.price|gyd }}</small>
              </div>
              <div class="text-end">
                <small class="fw-semibold">{{ item.line_total|gyd }}</small>
              </div>
            </div>
          {% endfor %}
        </div>
        
        <hr>
        
        <!-- Pricing Breakdown -->
        <div class="d-flex justify-content-between mb-2">
          <span>Subtotal:</span>
          <span>{{ total|gyd }}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Shipping:</span>
          <span class="text-success">Free</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Tax:</span>
          <span>Included</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between mb-3">
          <strong>Total:</strong>
          <strong class="price-large">{{ total|gyd }}</strong>
        </div>
        
        {% if total_usd %}
        <div class="alert alert-light text-center">
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            Approximately USD ${{ '%.2f'|format(total_usd) }}
          </small>
        </div>
        {% endif %}
        
        <!-- Security Notice -->
        <div class="text-center mt-3">
          <div class="d-flex align-items-center justify-content-center text-muted small">
            <i class="bi bi-shield-check me-2"></i>
            <span>Secure checkout guaranteed</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Order Support -->
    <div class="card mt-3">
      <div class="card-body text-center">
        <h6>Need Help?</h6>
        {% if settings.phone %}
        <p class="small text-muted mb-2">Contact us for assistance</p>
        <a href="tel:{{ settings.phone }}" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-telephone me-1"></i>
          {{ settings.phone }}
        </a>
        {% endif %}
        {% if settings.contact_email %}
        <div class="mt-2">
          <a href="mailto:{{ settings.contact_email }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-envelope me-1"></i>
            Email Us
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Terms and Conditions -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="termsCheck" required>
          <label class="form-check-label small" for="termsCheck">
            I agree to the 
            <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#termsModal">Terms and Conditions</a>
            and 
            <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy Policy</a>
          </label>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Terms Modal -->
<div class="modal fade" id="termsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Terms and Conditions</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6>Order Terms</h6>
        <p>By placing an order with {{ settings.store_name }}, you agree to the following terms:</p>
        <ul>
          <li>All orders are subject to availability</li>
          <li>Prices are displayed in Guyanese Dollars (GYD)</li>
          <li>We reserve the right to cancel orders for any reason</li>
          <li>Delivery times are estimates and may vary</li>
        </ul>
        
        <h6>Payment Terms</h6>
        <ul>
          <li>PayPal payments are processed immediately</li>
          <li>Cash on delivery orders require payment upon delivery</li>
          <li>We do not store payment information</li>
        </ul>
        
        <h6>Return Policy</h6>
        <p>Please contact us within 7 days of delivery for any issues with your order.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Privacy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Privacy Policy</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6>Information We Collect</h6>
        <p>We collect the following information to process your order:</p>
        <ul>
          <li>Name and contact information</li>
          <li>Delivery address</li>
          <li>Order details and payment method</li>
        </ul>
        
        <h6>How We Use Your Information</h6>
        <ul>
          <li>To process and fulfill your orders</li>
          <li>To communicate about your order status</li>
          <li>To provide customer support</li>
        </ul>
        
        <h6>Information Security</h6>
        <p>We protect your personal information and do not share it with third parties except as necessary to fulfill your order.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('#checkout-form');
  const termsCheck = document.querySelector('#termsCheck');
  const paymentButtons = document.querySelectorAll('#pay-paypal, #pay-cash');
  
  // Disable payment buttons until terms are accepted
  function updatePaymentButtons() {
    paymentButtons.forEach(btn => {
      btn.disabled = !termsCheck.checked;
    });
  }
  
  termsCheck.addEventListener('change', updatePaymentButtons);
  updatePaymentButtons(); // Initial state
  
  // Payment method card selection visual feedback
  document.addEventListener('click', function(e) {
    if (e.target.closest('.payment-method-card')) {
      document.querySelectorAll('.payment-method-card').forEach(card => {
        card.classList.remove('border-primary');
      });
      e.target.closest('.payment-method-card').classList.add('border-primary');
    }
  });
  
  function bodyFromForm() {
    const fd = new FormData(form);
    return {
      name: fd.get('name')?.trim() || '',
      email: fd.get('email')?.trim() || '',
      phone: fd.get('phone')?.trim() || '',
      address: fd.get('address')?.trim() || ''
    };
  }
  
  function validateForm() {
    const data = bodyFromForm();
    const errors = [];
    
    if (!data.name) errors.push('Name is required');
    if (!data.email) errors.push('Email is required');
    if (!data.phone) errors.push('Phone is required');
    if (!data.address) errors.push('Address is required');
    if (!termsCheck.checked) errors.push('Please accept the terms and conditions');
    
    if (data.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
      errors.push('Please enter a valid email address');
    }
    
    return errors;
  }
  
  async function processOrder(paymentMethod) {
    const errors = validateForm();
    if (errors.length > 0) {
      alert('Please fix the following errors:\n' + errors.join('\n'));
      return;
    }
    
    const endpoint = paymentMethod === 'paypal' ? 
      "{{ url_for('store.api_order_paypal') }}" : 
      "{{ url_for('store.api_order_cash') }}";
    
    const btn = document.getElementById(`pay-${paymentMethod}`);
    const originalText = btn.innerHTML;
    
    try {
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner me-2"></span>Processing...';
      
      const response = await fetch(endpoint, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(bodyFromForm())
      });
      
      const data = await response.json();
      
      if (data.ok) {
        // Show success message
        const successHtml = `
          <div class="alert alert-success text-center">
            <i class="bi bi-check-circle-fill display-4 text-success mb-3"></i>
            <h4>Order Placed Successfully!</h4>
            <p>Order #${data.order_id} has been placed.</p>
            <p class="small text-muted">Redirecting you to the homepage...</p>
          </div>
        `;
        document.querySelector('main .container').innerHTML = successHtml;
        
        // Open WhatsApp if available
        if (data.wa_url) {
          setTimeout(() => window.open(data.wa_url, "_blank"), 1000);
        }
        
        // Redirect to homepage
        setTimeout(() => window.location.href = "{{ url_for('store.index') }}", 3000);
      } else {
        alert(data.error || `Failed to process ${paymentMethod} order`);
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    } catch (error) {
      console.error('Order error:', error);
      alert('Network error. Please try again.');
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }
  
  document.querySelector('#pay-cash').addEventListener('click', () => processOrder('cash'));
  document.querySelector('#pay-paypal').addEventListener('click', () => processOrder('paypal'));
});
</script>
{% endblock %}
