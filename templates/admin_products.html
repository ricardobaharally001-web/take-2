{% extends "base_admin.html" %}
{% block content %}
<div class="container py-4">

  {% if create_view or edit_view %}
  <h1 class="h4 mb-3">{{ "Edit Product" if edit_view else "New Product" }}</h1>
  <form method="post" enctype="multipart/form-data" class="card p-3">
    {{ form.hidden_tag() }}
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Name</label>
        {{ form.name(class="form-control") }}
      </div>
      <div class="col-md-3">
        <label class="form-label">Price (GYD)</label>
        {{ form.price(class="form-control") }}
      </div>
      <div class="col-md-3">
        <label class="form-label">Category</label>
        {{ form.category(class="form-control") }}
      </div>
      <div class="col-12">
        <label class="form-label">Description</label>
        {{ form.description(class="form-control", rows="4") }}
      </div>
      <div class="col-md-6">
        <label class="form-label">Image (jpg/png)</label>
        {{ form.image(class="form-control") }}
        <div class="form-text">Images are stored in Supabase Storage (bucket: products).</div>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <div class="form-check">
          {{ form.is_active(class="form-check-input") }}
          <label class="form-check-label">Active</label>
        </div>
      </div>
    </div>

    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-primary" type="submit">Save</button>
      <a class="btn btn-secondary" href="{{ url_for('admin.admin_products') }}">Cancel</a>
    </div>
  </form>
  {% else %}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4">Products</h1>
    <a class="btn btn-primary" href="{{ url_for('admin.admin_products_new') }}">New Product</a>
  </div>

  {% if products %}
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Image</th><th>Name</th><th>Category</th><th>Price</th><th>Active</th><th></th>
        </tr>
      </thead>
      <tbody>
      {% for p in products %}
        {% set img = p.image_filename %}
        {% if img %}
          {% if img.startswith('http') %}
            {% set img_src = img %}
          {% else %}
            {% set img_src = url_for('uploaded_file', filename=img) %}
          {% endif %}
        {% else %}
          {% set img_src = 'https://via.placeholder.com/120x80?text=No+Image' %}
        {% endif %}
        <tr>
          <td><img src="{{ img_src }}" style="height:60px;object-fit:cover;border-radius:6px;"></td>
          <td>{{ p.name }}</td>
          <td>{{ p.category or "-" }}</td>
          <td>{{ p.price|gyd }}</td>
          <td>{{ "Yes" if p.is_active else "No" }}</td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('admin.admin_products_edit', pid=p.id) }}">Edit</a>
            <form method="post" action="{{ url_for('admin.admin_products_delete', pid=p.id) }}" style="display:inline" onsubmit="return confirm('Delete this product?')">
              {{ csrf_token() }}
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p>No products yet.</p>
  {% endif %}

  {% endif %}
</div>
{% endblock %}
