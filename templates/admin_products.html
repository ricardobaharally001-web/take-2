{% extends "base_admin.html" %}
{% block content %}
<div class="container py-4">

  {% if create_view or edit_view %}
  <!-- Create/Edit Product Form -->
  <div class="d-flex align-items-center mb-4">
    <a href="{{ url_for('admin.admin_products') }}" class="btn btn-outline-secondary me-3">
      ‚Üê Back
    </a>
    <h1 class="h4 mb-0">üì¶ {{ "Edit Product" if edit_view else "New Product" }}</h1>
  </div>
  
  <form method="post" enctype="multipart/form-data" class="card p-4">
    {{ form.hidden_tag() }}
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Product Name *</label>
        {{ form.name(class="form-control") }}
        {% for error in form.name.errors %}
          <div class="form-text text-danger">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-md-3">
        <label class="form-label">Price (GYD) *</label>
        {{ form.price(class="form-control") }}
        {% for error in form.price.errors %}
          <div class="form-text text-danger">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-md-3">
        <label class="form-label">Stock Quantity *</label>
        {{ form.stock_quantity(class="form-control", min="0") }}
        {% for error in form.stock_quantity.errors %}
          <div class="form-text text-danger">{{ error }}</div>
        {% endfor %}
        <small class="form-text text-muted">Number of items in inventory</small>
      </div>
      <div class="col-md-6">
        <label class="form-label">Category</label>
        {{ form.category_id(class="form-select") }}
        <small class="form-text text-muted">
          <a href="{{ url_for('admin.admin_categories_new') }}" class="text-decoration-none">
            ‚ûï Create new category
          </a>
        </small>
        {% for error in form.category_id.errors %}
          <div class="form-text text-danger">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <div class="form-check">
          {{ form.is_active(class="form-check-input") }}
          <label class="form-check-label">Active (visible to customers)</label>
        </div>
      </div>
      <div class="col-12">
        <label class="form-label">Description</label>
        {{ form.description(class="form-control", rows="4") }}
        {% for error in form.description.errors %}
          <div class="form-text text-danger">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-md-6">
        <label class="form-label">Product Image (jpg/png)</label>
        {{ form.image(class="form-control") }}
        <div class="form-text">Images are stored in Supabase Storage</div>
        {% for error in form.image.errors %}
          <div class="form-text text-danger">{{ error }}</div>
        {% endfor %}
      </div>
      {% if edit_view and product.image_filename %}
      <div class="col-md-6">
        <label class="form-label">Current Image</label>
        <div>
          {% set img_src = product.image_filename if product.image_filename.startswith('http') else url_for('uploaded_file', filename=product.image_filename) %}
          <img src="{{ img_src }}" style="height: 120px; object-fit: cover; border-radius: 6px; border: 1px solid #dee2e6;" alt="{{ product.name }}">
        </div>
      </div>
      {% endif %}
    </div>

    <div class="mt-4 d-flex gap-2">
      <button class="btn btn-primary" type="submit">
        <span>{% if edit_view %}üíæ Update Product{% else %}üì¶ Create Product{% endif %}</span>
      </button>
      <a class="btn btn-secondary" href="{{ url_for('admin.admin_products') }}">
        <span>Cancel</span>
      </a>
    </div>
  </form>
  
  {% else %}
  <!-- Products List -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h4 mb-0">üì¶ Products</h1>
      {% if current_category %}
        <small class="text-muted">in category: <strong>{{ current_category.name }}</strong></small>
      {% endif %}
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('admin.admin_categories') }}">
        <span>üìÅ Manage Categories</span>
      </a>
      <a class="btn btn-primary btn-lg" href="{{ url_for('admin.admin_products_new') }}">
        <span>‚ûï New Product</span>
      </a>
    </div>
  </div>

  <!-- Category Filter -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h6 class="mb-0">Filter by Category:</h6>
        </div>
        <div class="col-md-6">
          <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('admin.admin_products') }}" 
               class="btn btn-sm {{ 'btn-primary' if not current_category else 'btn-outline-primary' }}">
              All Products
            </a>
            {% for category in categories %}
            <a href="{{ url_for('admin.admin_products', category=category.id) }}" 
               class="btn btn-sm {{ 'btn-primary' if current_category and current_category.id == category.id else 'btn-outline-primary' }}">
              {{ category.name }} ({{ category.product_count() }})
            </a>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if products %}
  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 80px;">Image</th>
            <th>Product</th>
            <th>Category</th>
            <th>Price</th>
            <th>Stock</th>
            <th style="width: 80px;">Status</th>
            <th style="width: 200px;" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for p in products %}
          {% set img = p.image_filename %}
          {% if img %}
            {% if img.startswith('http') %}
              {% set img_src = img %}
            {% else %}
              {% set img_src = url_for('uploaded_file', filename=img) %}
            {% endif %}
          {% else %}
            {% set img_src = 'https://via.placeholder.com/120x80?text=No+Image' %}
          {% endif %}
          <tr class="{{ 'table-warning' if p.low_stock and p.is_in_stock else '' }}">
            <td>
              <img src="{{ img_src }}" 
                   style="height:60px; width:60px; object-fit:cover; border-radius:6px; border: 1px solid #dee2e6;" 
                   alt="{{ p.name }}">
            </td>
            <td>
              <div class="fw-semibold">{{ p.name }}</div>
              {% if p.description %}
                <small class="text-muted">{{ p.description[:50] }}{% if p.description|length > 50 %}...{% endif %}</small>
              {% endif %}
            </td>
            <td>
              {% if p.category %}
                <span class="badge bg-secondary">{{ p.category }}</span>
              {% else %}
                <span class="text-muted">Uncategorized</span>
              {% endif %}
            </td>
            <td>
              <strong>{{ p.price|gyd }}</strong>
            </td>
            <td>
              {% if p.stock_quantity == 0 %}
                <span class="badge bg-danger">Out of Stock</span>
              {% elif p.low_stock %}
                <span class="badge bg-warning text-dark">Low Stock ({{ p.stock_quantity }})</span>
              {% else %}
                <span class="badge bg-success">{{ p.stock_quantity }} in stock</span>
              {% endif %}
            </td>
            <td>
              {% if p.is_active %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-secondary">Inactive</span>
              {% endif %}
            </td>
            <td class="text-end">
              <div class="d-flex gap-2 justify-content-end">
                <a class="btn btn-sm btn-outline-primary" 
                   href="{{ url_for('admin.admin_products_edit', pid=p.id) }}" 
                   title="Edit Product">
                  <span>‚úèÔ∏è Edit</span>
                </a>
                <form method="post" 
                      action="{{ url_for('admin.admin_products_delete', pid=p.id) }}" 
                      style="display:inline" 
                      onsubmit="return confirm('Are you sure you want to delete &quot;{{ p.name }}&quot;?')">
                  {{ csrf_token() }}
                  <button class="btn btn-sm btn-outline-danger" 
                          type="submit" 
                          title="Delete Product">
                    <span>üóëÔ∏è Delete</span>
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Summary -->
  <div class="mt-4 row g-3">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">üìä Inventory Summary</h5>
          <div class="row g-2">
            <div class="col-4">
              <div class="fw-bold text-primary">{{ products|length }}</div>
              <small class="text-muted">Total Products</small>
            </div>
            <div class="col-4">
              <div class="fw-bold text-success">{{ products|selectattr('is_in_stock')|list|length }}</div>
              <small class="text-muted">In Stock</small>
            </div>
            <div class="col-4">
              <div class="fw-bold text-warning">{{ products|selectattr('low_stock')|list|length }}</div>
              <small class="text-muted">Low Stock</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6 d-flex align-items-center justify-content-end">
      <a class="btn btn-outline-primary me-2" href="{{ url_for('admin.admin_products_new') }}">
        <span>‚ûï Add Another Product</span>
      </a>
      {% if current_category %}
      <a class="btn btn-outline-secondary" href="{{ url_for('admin.admin_products') }}">
        <span>View All Products</span>
      </a>
      {% endif %}
    </div>
  </div>
  
  {% else %}
  <!-- Empty State -->
  <div class="card">
    <div class="card-body text-center py-5">
      <div class="display-1 text-muted mb-3">üì¶</div>
      {% if current_category %}
        <h4 class="text-muted">No Products in "{{ current_category.name }}"</h4>
        <p class="text-muted mb-4">Add your first product to this category.</p>
        <a href="{{ url_for('admin.admin_products_new') }}?category={{ current_category.id }}" class="btn btn-primary btn-lg me-2">
          <span>üì¶ Add Product to {{ current_category.name }}</span>
        </a>
        <a href="{{ url_for('admin.admin_products') }}" class="btn btn-outline-secondary">
          <span>View All Products</span>
        </a>
      {% else %}
        <h4 class="text-muted">No Products Yet</h4>
        <p class="text-muted mb-4">Start building your inventory by adding your first product.</p>
        {% if categories %}
        <a href="{{ url_for('admin.admin_products_new') }}" class="btn btn-primary btn-lg">
          <span>üì¶ Add Your First Product</span>
        </a>
        {% else %}
        <div class="mb-3">
          <p class="text-muted">Create categories first to organize your products better.</p>
        </div>
        <a href="{{ url_for('admin.admin_categories_new') }}" class="btn btn-success btn-lg me-2">
          <span>üìÅ Create Categories First</span>
        </a>
        <a href="{{ url_for('admin.admin_products_new') }}" class="btn btn-primary btn-lg">
          <span>üì¶ Add Product Without Category</span>
        </a>
        {% endif %}
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Add loading state to delete buttons
  document.addEventListener('submit', function(e) {
    if (e.target.matches('form[onsubmit*="confirm"]')) {
      const btn = e.target.querySelector('button[type="submit"]');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span>üóëÔ∏è Deleting...</span>';
      }
    }
  });

  // Add loading state to form submit
  document.addEventListener('submit', function(e) {
    if (e.target.matches('form[enctype="multipart/form-data"]')) {
      const btn = e.target.querySelector('button[type="submit"]');
      if (btn) {
        btn.disabled = true;
        const isEdit = btn.textContent.includes('Update');
        btn.innerHTML = isEdit ? '<span>üíæ Updating...</span>' : '<span>üì¶ Creating...</span>';
      }
    }
  });

  // Stock quantity validation
  const stockInput = document.querySelector('input[name="stock_quantity"]');
  if (stockInput) {
    stockInput.addEventListener('input', function() {
      const value = parseInt(this.value);
      const warning = document.getElementById('stockWarning');
      
      if (warning) warning.remove(); // Remove existing warning
      
      if (value <= 5 && value > 0) {
        const warningDiv = document.createElement('div');
        warningDiv.id = 'stockWarning';
        warningDiv.className = 'form-text text-warning';
        warningDiv.innerHTML = '‚ö†Ô∏è Low stock warning: Consider restocking soon';
        this.parentNode.appendChild(warningDiv);
      } else if (value === 0) {
        const warningDiv = document.createElement('div');
        warningDiv.id = 'stockWarning';
        warningDiv.className = 'form-text text-danger';
        warningDiv.innerHTML = '‚ùå Out of stock: Product will not be visible to customers';
        this.parentNode.appendChild(warningDiv);
      }
    });
  }

  // Auto-select category if coming from category page
  const urlParams = new URLSearchParams(window.location.search);
  const categoryParam = urlParams.get('category');
  if (categoryParam) {
    const categorySelect = document.querySelector('select[name="category_id"]');
    if (categorySelect) {
      categorySelect.value = categoryParam;
    }
  }
});
</script>

<style>
/* Low stock row highlighting */
.table-warning {
  background-color: rgba(255, 193, 7, 0.1) !important;
}

/* Category filter buttons */
.btn-group .btn-sm {
  white-space: nowrap;
}

/* Stock badges */
.badge {
  font-size: 0.75em;
}

/* Inventory summary cards */
.card-body .fw-bold {
  font-size: 1.5rem;
}
</style>
{% endblock %}
